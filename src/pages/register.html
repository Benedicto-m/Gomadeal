<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Enregistrer un appareil â€” GomaDeal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

</head>
<body class="bg-gray-50 min-h-screen p-6 flex items-center justify-center">
  <div class="max-w-md w-full bg-white p-6 rounded-lg shadow">
    <h1 class="text-2xl font-bold mb-4 text-center">ğŸ“± Enregistrer un appareil</h1>

    <form id="registerForm" class="space-y-3">
      <input id="imei" name="imei"  required placeholder="IMEI (15 chiffres)" class="w-full p-2 border rounded" maxlength="15" pattern="\d{15}" title="Un IMEI valide contient exactement 15 chiffres"/>
      <input id="brand" placeholder="Marque" class="w-full p-2 border rounded" />
      <input id="model" placeholder="ModÃ¨le" class="w-full p-2 border rounded" />
      <input id="owner_contact" placeholder="Contact propriÃ©taire" class="w-full p-2 border rounded" />
      <button class="bg-blue-600 text-white w-full py-2 rounded">Enregistrer</button>
    </form>

    <div id="result" class="mt-4 hidden">
  <h2 class="font-semibold text-lg mb-2">âœ… Enregistrement rÃ©ussi</h2>
  <p>Code GomaDeal : <span id="gdcode" class="font-mono text-blue-600"></span></p>
  <div id="qrcode" class="mt-4"></div>
  <button id="saveQrBtn" class="bg-green-600 text-white w-full py-2 rounded mt-3">Enregistrer le QR</button>
</div>

</div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";
  import QRCode from "https://cdn.jsdelivr.net/npm/qrcode/+esm";

  const SUPABASE_URL = "https://hdtxbiemeitwuslgwfbl.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhkdHhiaWVtZWl0d3VzbGd3ZmJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIyNjU5MjAsImV4cCI6MjA3Nzg0MTkyMH0.obMpgyrxAobXfoNYW8qV0ApVFntnHvjmKsDvA0fN1Rw";

  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const form = document.getElementById('registerForm');
  const result = document.getElementById('result');
  const gdcodeEl = document.getElementById('gdcode');
  const qrContainer = document.getElementById('qrcode');
  const saveQrBtn = document.getElementById('saveQrBtn');

  let lastQrCanvas = null; // pour sauvegarde

 form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const imeiVal = document.getElementById('imei').value.trim();
  // Validation IMEI : exactement 15 chiffres
  if (!/^\d{15}$/.test(imeiVal)) {
    alert("L'IMEI doit contenir exactement 15 chiffres.");
    return;
  }

  try {
    const data = {
      imei: imeiVal,
      brand: document.getElementById('brand').value,
      model: document.getElementById('model').value,
      owner_contact: document.getElementById('owner_contact').value
    };

    const { data: device, error } = await supabase.rpc('register_device', {
      p_imei: data.imei,
      p_brand: data.brand,
      p_model: data.model,
      p_owner_contact: data.owner_contact,
      p_image_path: null
    });

    if (error) throw error;

    const code = device[0].gomadeal_code;
    gdcodeEl.textContent = code;
    result.classList.remove('hidden');
    form.reset();

    const verifyUrl = `${window.location.origin}/verify.html?code=${encodeURIComponent(code)}`;
    qrContainer.innerHTML = "";
    QRCode.toCanvas(verifyUrl, { width: 200 }, function (err, canvas) {
      if (err) {
        console.error(err);
        return;
      }
      lastQrCanvas = canvas;
      qrContainer.appendChild(canvas);
    });

  } catch (err) {
    alert("Erreur : " + err.message);
  }
});


  // Bouton pour sauvegarder le QR
  saveQrBtn.addEventListener('click', () => {
    if (!lastQrCanvas) return;
    const link = document.createElement('a');
    link.download = 'gomadeal_qr.png';
    link.href = lastQrCanvas.toDataURL("image/png");
    link.click();
  });
</script>

</body>
</html>
